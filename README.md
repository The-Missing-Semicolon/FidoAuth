# FIDO Proxy Authenticator

A simple utility to facilitate implementing a reverse proxy that provides two factor authentication with FIDO2 support.

This was derived from the FIDO2 authentication code in https://github.com/newhouseb/nginxwebauthn.

### Why

I created this because I wanted a simple local two factor authentication solution for various self hosted services on my home network. While, in conjunction with `mod_auth_tkt`, this could likely be used to create a single sign on solution, that was not my intention for creating this. At the scale of my network, a single sign on solution would simply be a single point of failure, from both functional and security perspectives.

### What is FIDO2

FIDO2 combines W3C's WebAuthn standard (generic protocol for performing public key authentication over a network) with the FIDO Alliance's CTAP standard (protocol for communicating with a hardware authentication token) <sub>[source](https://fidoalliance.org/fido2/)</sub>.

The major benefits of FIDO2, versus other authentication protocols, are....
* Public key based authentication, means that there is no shared key between clients and servers, unlike most OTP implementations.
* The private key *cannot* leave the hardware device, so they key can't be stolen (short of an attacker stealing the physical hardware token).
* Interaction is required with the device during the authentication process (generally in the form of touching/tapping the hardware token). This way, an attacker can't leverage the device being plugged in to perform a malicious authentication.

## Configuration
* Install the FidoAuth wheel into a virtual environment.
* Write a config file to `/etc/fidoproxy.conf`, for your environment. The config defaults are embedded in the FidoAuth wheel in [`default.cfg`](src/fidoauth/config/default.cfg), refer to this file for details on the config parameters.
* Run the `fido_generate_key` entry point to generate the secret for `mod_auth_token`.
* Create a wsgi script, such as the following...
    ```
    import fidoauth.wsgi
    def application(environ, start_response):
        return fidoauth.wsgi.application(environ, start_response)
    ```
* Once the config file has been created, configure your web server using one of the options below...

### Apache Configuration with `mod_auth_tkt`
* Install and enable `mod_wsgi` and `mod_auth_tkt` for Apache.
* Configure the server to run the WSGI script in the virtual environment (see the sample WSGI script below).
* Configure two locations in the Apache config...
  * One that hosts the GUI for the authenticator. This one should allow unauthenticated users.
  * The other location hosts the resource being protected, and should only allow users authenticated by `mod_auth_tkt`. In the sample below, the service is a reverse proxy.   
    * Configure `mod_auth_tkt` to redirect to the `login` url.
    * _Optional_ If the service supports external authentication configure the appropraite headers.
* Import the file generated by `fido_generate_key`.

#### Sample Configuration for Apache with `mod_auth_tkt`
```
<VirtualHost *:443>
    ServerName test.fido

    # For a browser to perform FIDO authentication, the page must be served over TLS, and the site must be trusted (not just excepted).
    SSLEngine on
    SSLCertificateFile    /etc/pki/httpd/testfido.crt
    SSLCertificateKeyFile /etc/pki/httpd/testfido.key
    
    ProxyRequests off
    ProxyPreserveHost on
    
    # This config file is generated by running the fido_generate_key entry point, and sets the TKTAuthSecret and TKTAuthDigestType parameters for mod_auth_tkt.
    Include /etc/fidoauth/mod_tkt_config.conf
    
    DirectoryIndex paperless
    
    # The service being protected
    <Location /fidoauth>
        AuthType None
        Require all granted
    </Location>
    
    # The service being protected
    <Location /paperless>
        AuthType None
        Require valid-user
        TKTAuthLoginURL https://test.fido/fidoauth/login
        RequestHeader set Remote-User "%{REMOTE_USER}e"
    
        ProxyPass http://127.0.0.1:8000/paperless upgrade=websocket
        ProxyPassReverse http://127.0.0.1:8000/paperless
    </Location>
    
    WSGIDaemonProcess fidoauth python-home=/opt/fidoauth/venv
    WSGIProcessGroup fidoauth
    WSGIScriptAlias /fidoauth /var/www/wsgi-scripts/fidoauth.wsgi
</VirtualHost>
```

### Apache Configuration with `mod_auth_pubtkt`

TODO Implement this

### nginx Configuration

TODO Implement this

## Usage

### Registering Users
Registering users requires shell access to the server.

* Navigate to the service. If configured properly, the server will redirect to the authentication page.
* Click the "Register Key" link, below the credentials form.
* Enter the username, and click "Being Registration". This will cause the client browser to run the token registration process.
* Once that has completed, run the `fido_save_creds` entry point on the server with the provided arguments to store the key. This will prompt for the users password.

